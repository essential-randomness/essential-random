---
import TimeToggle from "./TimeToggle.astro";
---

<local-time timezone="original">
  <div class="live-now">...live now (maybe)</div>
  <time class="recurring">Mondays & Thursdays, 3PM Pacific</time>
  <div class="local-time">(Your time)</div>
  <div class="global-time">(Pacific time)</div>
</local-time>

<TimeToggle />

<script>
  const MONDAY = 1;
  const THURSDAY = 4;
  const STREAM_START_TIME = 15;
  const STREAM_END_TIME = 18;
  function getNextDayAt3PM(targetDay: number, fromDate: Date = new Date()) {
    const next = new Date(fromDate);
    const daysUntil = (targetDay - fromDate.getDay() + 7) % 7;
    next.setDate(fromDate.getDate() + (daysUntil === 0 ? 7 : daysUntil));
    next.setHours(15, 0, 0, 0);
    return next;
  }

  function isLiveNow() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    return (
      (day === MONDAY || day === THURSDAY) &&
      hour >= STREAM_START_TIME &&
      hour < STREAM_END_TIME
    );
  }

  function getClosestStreamDay() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    // If stream day after 6PM, search from tomorrow
    const searchFrom =
      (day === MONDAY || day === THURSDAY) && hour >= STREAM_END_TIME
        ? new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1)
        : now;
    const nextMonday = getNextDayAt3PM(MONDAY, searchFrom);
    const nextThursday = getNextDayAt3PM(THURSDAY, searchFrom);
    return nextMonday < nextThursday ? nextMonday : nextThursday;
  }

  const timeTag = document.querySelector("time.recurring");
  if (!timeTag) {
    throw new Error("No time tag found");
  }

  function getTodayAt3PM() {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 15, 0, 0);
  }

  const localTime = document.querySelector("local-time");
  const nextStream = isLiveNow() ? getTodayAt3PM() : getClosestStreamDay();

  localTime?.classList.toggle("live", isLiveNow());

  timeTag.innerHTML = new Date(nextStream).toLocaleString("en-US", {
    timeZone: "US/Pacific",
    dateStyle: "full",
    timeStyle: "short",
  });
</script>

<style>
  time {
    font-weight: bold;
    font-size: 2.25rem;
  }
  local-time {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  local-time[timezone="local"] .global-time {
    display: none;
  }
  local-time[timezone="original"] .local-time {
    display: none;
  }
  local-time .live-now {
    display: none;
    font-weight: bold;
    font-size: 4.25rem;
  }
  local-time.live .live-now {
    display: block;
  }
  local-time.live :not(.live-now),
  local-time.live + .toggles {
    display: none;
  }
</style>

